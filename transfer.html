<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StefiApp - Transferir</title>
  <link rel="stylesheet" href="global.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Transferencias</h1>

    <div id="menu">
      <button onclick="elegirModo('transfer')">Transferir</button>
      <button onclick="elegirModo('qr')">Crear QR</button>
    </div>

    <div id="form-transfer" class="hidden">
      <input id="alias" type="text" placeholder="Alias del destinatario" />
      <input id="monto" type="number" placeholder="Monto a transferir" />
      <button onclick="realizarTransferencia()">Enviar</button>
    </div>

    <div id="form-qr" class="hidden">
      <input id="montoQr" type="number" placeholder="Monto para el QR" />
      <button onclick="crearQR()">Crear QR</button>
      <div id="qr-result" class="qr-display"></div>
    </div>
  </div>

  <script type="module">
import { db, getUserData, updateUserData } from "./scripts/firebase.js";

window.realizarTransferencia = async () => {
  const receptorAlias = document.getElementById("alias").value.trim();
  const monto = parseFloat(document.getElementById("monto").value);

  if (!receptorAlias || isNaN(monto) || monto <= 0) {
    alert("Datos inválidos");
    return;
  }

  // 👤 Obtener usuario actual desde localStorage
  const user = JSON.parse(localStorage.getItem("user"));
  const userId = user?.id;

  if (!userId) {
    alert("Usuario no autenticado");
    return;
  }

  // 📥 Obtener emisor directamente
  const emisorSnap = await get(child(ref(db), `estudiantes/${userId}`));
  const emisor = emisorSnap.exists() ? emisorSnap.val() : null;

  // 🔍 Buscar receptor por alias
  const receptor = await getUserData(receptorAlias);

  if (!emisor || !receptor) {
    alert("Alias no encontrado");
    return;
  }

  if ((emisor.coins || 0) < monto) {
    alert("Fondos insuficientes");
    return;
  }

  const nuevoSaldoEmisor = (emisor.coins || 0) - monto;
  const nuevoSaldoReceptor = (receptor.coins || 0) + monto;

  const actualizadoEmisor = { ...emisor, coins: nuevoSaldoEmisor };
  const actualizadoReceptor = { ...receptor, coins: nuevoSaldoReceptor };

  const ok1 = await updateUserData(userId, actualizadoEmisor);
  const ok2 = await updateUserData(receptor._id, actualizadoReceptor);

  if (ok1 && ok2) {
    alert("Transferencia realizada con éxito");
  } else {
    alert("Error al guardar la transferencia");
  }
};

  </script>
</body>
</html>
