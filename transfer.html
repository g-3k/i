<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StefiApp - Transferir</title>
  <link rel="stylesheet" href="global.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Transferencias</h1>

    <div id="menu">
      <button onclick="elegirModo('transfer')">Transferir</button>
      <button onclick="elegirModo('qr')">Crear QR</button>
    </div>

    <div id="form-transfer" class="hidden">
      <input id="alias" type="text" placeholder="Alias del destinatario" />
      <input id="monto" type="number" placeholder="Monto a transferir" />
      <button onclick="realizarTransferencia()">Enviar</button>
    </div>

    <div id="form-qr" class="hidden">
      <input id="montoQr" type="number" placeholder="Monto para el QR" />
      <button onclick="crearQR()">Crear QR</button>
      <div id="qr-result" class="qr-display"></div>
    </div>
  </div>

  <script type="module">
    import { db, getUserData, updateUserData } from "./scripts/firebase.js";
    import { get, ref, child } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    function elegirModo(modo) {
      document.getElementById("form-transfer").classList.add("hidden");
      document.getElementById("form-qr").classList.add("hidden");
      if (modo === "transfer") {
        document.getElementById("form-transfer").classList.remove("hidden");
      } else {
        document.getElementById("form-qr").classList.remove("hidden");
      }
    }

    window.elegirModo = elegirModo;

    window.realizarTransferencia = async () => {
      const receptorAlias = document.getElementById("alias").value.trim();
      const monto = parseFloat(document.getElementById("monto").value);

      if (!receptorAlias || isNaN(monto) || monto <= 0) {
        alert("Datos inválidos");
        return;
      }

      const user = JSON.parse(localStorage.getItem("user"));
      const emisorId = user?.id;

      if (!emisorId) {
        alert("Usuario no autenticado");
        return;
      }

      // Obtener emisor por ID
      const emisorSnap = await get(child(ref(db), `estudiantes/${emisorId}`));
      const emisor = emisorSnap.exists() ? emisorSnap.val() : null;

      // Buscar receptor por alias
      const receptor = await getUserData(receptorAlias);

      if (!emisor || !receptor) {
        alert("Alias no encontrado");
        return;
      }

      if ((emisor.coins || 0) < monto) {
        alert("Fondos insuficientes");
        return;
      }

      const nuevoSaldoEmisor = (emisor.coins || 0) - monto;
      const nuevoSaldoReceptor = (receptor.coins || 0) + monto;

      const actualizadoEmisor = { ...emisor, coins: nuevoSaldoEmisor };
      const actualizadoReceptor = { ...receptor, coins: nuevoSaldoReceptor };

      const ok1 = await updateUserData(emisorId, actualizadoEmisor);
      const ok2 = await updateUserData(receptor._id, actualizadoReceptor);

      if (ok1 && ok2) {
        alert("Transferencia realizada con éxito");
      } else {
        alert("Error al guardar la transferencia");
      }
    };

    window.crearQR = async () => {
      const monto = parseFloat(document.getElementById("montoQr").value);

      if (isNaN(monto) || monto <= 0) {
        alert("Monto inválido");
        return;
      }

      const user = JSON.parse(localStorage.getItem("user"));
      const data = JSON.stringify({ origen: user?.id || "", monto });

      const container = document.getElementById("qr-result");
      container.innerHTML = "";

      try {
        const canvas = document.createElement("canvas");
        await QRCode.toCanvas(canvas, data, { width: 256 });
        container.appendChild(canvas);
      } catch (err) {
        alert("Error al generar QR: " + err);
      }
    };
  </script>
</body>
</html>
