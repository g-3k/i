<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Transferencias</title>
  <link rel="stylesheet" href="global.css">
</head>
<body>
  <div class="container">
    <h1>Transferencias</h1>
    <label>Tipo de acción:</label>
    <select id="actionSelector">
      <option value="">Selecciona una opción</option>
      <option value="transfer">Transferir</option>
      <option value="crearQR">Crear QR</option>
    </select>

    <div id="transferForm" style="display:none;">
      <input type="text" id="aliasDestino" placeholder="Alias destino">
      <input type="number" id="montoTransferir" placeholder="Monto">
      <button onclick="realizarTransferencia()">Transferir</button>
    </div>

    <div id="qrForm" style="display:none;">
      <input type="number" id="montoQR" placeholder="Monto para QR">
      <button onclick="crearQR()">Crear QR</button>
      <br>
      <canvas id="qrCanvas"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
  <script type="module">
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    import { db, usuarioActual } from './firebase.js';

    const selector = document.getElementById('actionSelector');
    const transferForm = document.getElementById('transferForm');
    const qrForm = document.getElementById('qrForm');

    selector.addEventListener('change', () => {
      transferForm.style.display = selector.value === 'transfer' ? 'block' : 'none';
      qrForm.style.display = selector.value === 'crearQR' ? 'block' : 'none';
    });

    window.realizarTransferencia = async function () {
      const alias = document.getElementById('aliasDestino').value.trim();
      const monto = parseFloat(document.getElementById('montoTransferir').value);
      if (!alias || isNaN(monto)) return alert('Datos inválidos');

      const origenRef = ref(db, `usuarios/${usuarioActual}`);
      const destinoRef = ref(db, `usuarios/${alias}`);

      const [origenSnap, destinoSnap] = await Promise.all([get(origenRef), get(destinoRef)]);

      if (!origenSnap.exists() || !destinoSnap.exists()) return alert("Alias no válido");
      if (origenSnap.val().saldo < monto) return alert("Saldo insuficiente");

      await update(origenRef, { saldo: origenSnap.val().saldo - monto });
      await update(destinoRef, { saldo: destinoSnap.val().saldo + monto });

      alert('Transferencia completada');
    }

    window.crearQR = async function () {
      const monto = parseFloat(document.getElementById('montoQR').value);
      if (isNaN(monto)) return alert("Monto inválido");

      const data = {
        desde: usuarioActual,
        monto
      };

      const canvas = document.getElementById("qrCanvas");
      QRCode.toCanvas(canvas, JSON.stringify(data), function (error) {
        if (error) console.error(error);
      });
    }
  </script>
</body>
</html>
