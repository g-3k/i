<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Transferencias</title>
  <link rel="stylesheet" href="global.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Transferencias</h1>

    <div class="button-group">
      <button id="btn-transferir">Transferir</button>
      <button id="btn-generar-qr">Crear QR</button>
    </div>

    <div id="form-transfer" class="formulario oculto">
      <h2>Transferir a un alias</h2>
      <input type="text" id="destino" placeholder="Alias del receptor" />
      <input type="number" id="monto" placeholder="Monto a transferir" />
      <button onclick="transferir()">Enviar</button>
    </div>

    <div id="form-qr" class="formulario oculto">
      <h2>Generar QR de transferencia</h2>
      <input type="number" id="montoQR" placeholder="Monto a transferir" />
      <button onclick="generarQR()">Generar</button>
      <div id="qrResultado" style="margin-top: 20px;"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    import { firebaseConfig } from "./firebase.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const aliasActual = localStorage.getItem("alias");

    document.getElementById("btn-transferir").onclick = () => {
      document.getElementById("form-transfer").classList.remove("oculto");
      document.getElementById("form-qr").classList.add("oculto");
    };

    document.getElementById("btn-generar-qr").onclick = () => {
      document.getElementById("form-qr").classList.remove("oculto");
      document.getElementById("form-transfer").classList.add("oculto");
    };

    window.transferir = async () => {
      const destino = document.getElementById("destino").value;
      const monto = parseInt(document.getElementById("monto").value);
      if (!destino || isNaN(monto)) return alert("Completa todos los campos");

      const dbRef = ref(db);
      try {
        const snapshot = await get(child(dbRef, `usuarios/${aliasActual}`));
        const datos = snapshot.val();
        if (!datos || datos.dinero < monto) return alert("Fondos insuficientes");

        const destinoSnap = await get(child(dbRef, `usuarios/${destino}`));
        if (!destinoSnap.exists()) return alert("El alias destino no existe");

        const nuevoOrigen = datos.dinero - monto;
        const nuevoDestino = destinoSnap.val().dinero + monto;

        await set(ref(db, `usuarios/${aliasActual}/dinero`), nuevoOrigen);
        await set(ref(db, `usuarios/${destino}/dinero`), nuevoDestino);

        alert("Transferencia exitosa");
      } catch (e) {
        alert("Error al transferir: " + e.message);
      }
    };

    window.generarQR = () => {
      const monto = parseInt(document.getElementById("montoQR").value);
      if (isNaN(monto)) return alert("Ingresa un monto vÃ¡lido");

      const datosQR = {
        alias: aliasActual,
        monto: monto,
      };

      const divQR = document.getElementById("qrResultado");
      divQR.innerHTML = "";
      QRCode.toCanvas(JSON.stringify(datosQR), { width: 256 }, (err, canvas) => {
        if (err) return alert("Error al generar el QR");
        divQR.appendChild(canvas);
      });
    };
  </script>
</body>
</html>
