<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Escanear QR - StefiApp</title>
  <link rel="stylesheet" href="global.css" />
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="qr-container">
    <h1>Escanear QR</h1>
    <div id="reader" style="width: 100%; max-width: 400px; margin: auto;"></div>

    <div class="manual-input">
      <p>O ingresalo manualmente:</p>
      <input type="text" id="manualCode" placeholder="Código QR" />
      <button onclick="procesarCodigo(document.getElementById('manualCode').value)">Enviar</button>
    </div>

    <div id="resultado"></div>
  </div>

  <script>
    const procesarCodigo = (codigo) => {
      document.getElementById("resultado").innerText = `Código recibido: ${codigo}`;

      // Redirigir o hacer algo con el código
      if (codigo.startsWith("stefi.app/transfer/?")) {
        const params = new URLSearchParams(codigo.split("?")[1]);
        const alias = params.get("alias");
        const puntos = parseInt(params.get("puntos"));

        if (alias && !isNaN(puntos)) {
          window.location.href = `transfer.html?alias=${alias}&puntos=${puntos}`;
        } else {
          alert("QR no válido");
        }
      }
    };

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        const cameraId = devices[0].id;
        html5QrCode.start(
          cameraId,
          {
            fps: 10,
            qrbox: 250
          },
          (decodedText) => {
            html5QrCode.stop();
            procesarCodigo(decodedText);
          },
          (errorMessage) => {
            console.log("Error escaneo:", errorMessage);
          }
        ).catch(err => {
          console.error("No se pudo iniciar la cámara:", err);
        });
      }
    }).catch(err => {
      console.error("No se encontraron cámaras:", err);
    });
  </script>
</body>
</html>
