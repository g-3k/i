<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Escanear QR - StefiApp</title>
  <link rel="stylesheet" href="global.css"/>
  <script type="module" src="firebase.js"></script>
</head>
<body>
  <div class="container">
    <h2>Escanear QR</h2>
    <video id="video" style="width: 100%; max-width: 400px;" autoplay></video>
    <p id="resultado"></p>
  </div>

  <script type="module">
    import { db, getCurrentUserAlias } from './firebase.js';
    import { ref, get, update } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

    const videoElem = document.getElementById('video');
    const resultado = document.getElementById('resultado');

    const scanner = new QrScanner(videoElem, async result => {
      scanner.stop();
      const [aliasOrigen, montoStr] = result.data.split('|');
      const monto = parseFloat(montoStr);
      const aliasDestino = await getCurrentUserAlias();

      const snapshot = await get(ref(db));
      const data = snapshot.val();

      const saldoOrigen = data.usuarios[aliasOrigen]?.dinero || 0;
      const saldoDestino = data.usuarios[aliasDestino]?.dinero || 0;

      if (saldoOrigen < monto) {
        resultado.textContent = "Saldo insuficiente del emisor.";
        return;
      }

      await update(ref(db, 'usuarios/' + aliasOrigen), { dinero: saldoOrigen - monto });
      await update(ref(db, 'usuarios/' + aliasDestino), { dinero: saldoDestino + monto });

      resultado.textContent = `¡Recibiste $${monto} de ${aliasOrigen}!`;
    }, {
      returnDetailedScanResult: true,
      preferredCamera: 'environment'
    });

    QrScanner.hasCamera().then(hasCamera => {
      if (hasCamera) scanner.start();
      else resultado.textContent = "No se detectó cámara.";
    });
  </script>
</body>
</html>
