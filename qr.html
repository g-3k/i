<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StefiApp - Transferir</title>
  <link rel="stylesheet" href="global.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
  <h1>Transferir Coins</h1>

  <label>Alias actual:</label>
  <input id="aliasInput" placeholder="Tu alias"/><br><br>

  <label>Alias destino:</label>
  <input id="destinoInput" placeholder="Alias de destino"/><br><br>

  <label>Monto:</label>
  <input id="montoInput" type="number" min="1" /><br><br>

  <button id="transferBtn">Transferir</button>

  <h3>Coins actuales: <span id="coinsLabel">?</span></h3>

  <script type="module">
    import { getUserData, updateUserData } from "./scripts/firebase.js";

    const aliasInput = document.getElementById("aliasInput");
    const destinoInput = document.getElementById("destinoInput");
    const montoInput = document.getElementById("montoInput");
    const transferBtn = document.getElementById("transferBtn");
    const coinsLabel = document.getElementById("coinsLabel");

    let usuarioActual = null;

    aliasInput.addEventListener("blur", async () => {
      const alias = aliasInput.value.trim();
      if (!alias) return;
      usuarioActual = await getUserData(alias);
      if (!usuarioActual) {
        coinsLabel.textContent = "Alias no encontrado";
        return;
      }
      coinsLabel.textContent = usuarioActual.coins || 0;
    });

    transferBtn.addEventListener("click", async () => {
      const destinoAlias = destinoInput.value.trim();
      const monto = parseInt(montoInput.value);

      if (!usuarioActual || !destinoAlias || isNaN(monto) || monto <= 0) {
        alert("Completa todos los campos correctamente.");
        return;
      }

      if (usuarioActual.coins < monto) {
        alert("No tienes suficientes coins.");
        return;
      }

      const receptor = await getUserData(destinoAlias);
      if (!receptor) {
        alert("Alias de destino no encontrado.");
        return;
      }

      const nuevoEmisor = { ...usuarioActual, coins: usuarioActual.coins - monto };
      const nuevoReceptor = { ...receptor, coins: (receptor.coins || 0) + monto };

      const exito1 = await updateUserData(usuarioActual._id, nuevoEmisor);
      const exito2 = await updateUserData(receptor._id, nuevoReceptor);

      if (exito1 && exito2) {
        alert("Transferencia realizada con Ã©xito.");
        coinsLabel.textContent = nuevoEmisor.coins;
        usuarioActual = nuevoEmisor;
      } else {
        alert("Error en la transferencia.");
      }
    });
  </script>
</body>
</html>
